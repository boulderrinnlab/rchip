---
title: "12_create_consensus_peaks"
author: "JR"
date: "10/31/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(GenomicRanges)
# source("/scratch/Shares/rinnclass/CLASS_2022/JR/CLASS_2022/util")
source("/scratch/Shares/rinnclass/CLASS_2022/<your_folder/CLASS_2022/util/intersect_functions.R")
```

Today we are going to practice running the create_consensus_peaks function. Then import the full dataset of 483 DBPs!

# running consensus peaks -- 30 min or so
# We are already running create_consensus_peaks form 11_consensus_peaks.RMD 
# So we can skip this but useful starting point.

```{r create_consensus_peaks -- run as local job}
# let's run our new function create consensus peaks -- let's run as local job
# so we first need to source util and the packages needed.
# now we need to make an Rscript and put in working dir (11)
# library(tidyverse)
# library(GenomicRanges)
# source("/scratch/Shares/rinnclass/CLASS_2022/JR/CLASS_2022/util/intersect_functions.R")
# source("/scratch/Shares/rinnclass/CLASS_2022/<your_folder>/CLASS_2022/util/intersect_functions.R")
# run consensus peaks
# consensus_peaks <- create_consensus_peaks("/scratch/Shares/rinnclass/CLASS_2022/data/peaks")


```

# export consensus peaks to CORRECT DIRECTORY!

```{R exporting consensus peaks to 11 directory}
# for(i in 1:length(consensus_peaks)) {
#  rtracklayer::export(consensus_peaks[[i]], 
#                     paste0("/scratch/Shares/rinnclass/CLASS_2022/JR/CLASS_2022/class_exeRcises/analysis/11_consensus_peaks/consensus_peaks/", 
#                             names(consensus_peaks)[i], 
#                             "_consensus_peaks.bed"))
# }
# Run local job by setting working dir to 11 - ref .R script
```

Great, now we have a bunch of data -- let's see where the peaks land in different annotations of the genome.
First let's make GRanges of mRNA and lncRNA promoter regions (save somewhere handy in your local folder)

# Making annotaiton files while consensus peaks runs:
# Creating genome annotation files

```{r reading in gencode annotations}
# first load in the gencode annotation file
gencode_gr <- rtracklayer::import("/scratch/Shares/rinnclass/CLASS_2022/data/genomes/gencode.v32.annotation.gtf")
```

## START POINT CONSENSUS PEAK SUMMARY ## 

# Consensus Peak Properties

```{R consensus_peak properties}
# make a list of file paths for consensus peaks
consensus_fl <- list.files("/scratch/Shares/rinnclass/CLASS_2022/JR/CLASS_2022/class_exeRcises/analysis/11_consensus_peaks/consensus_peaks", full.names = T)
# using lapply to import all the files in consensus_fl
consensus_peaks <- lapply(consensus_fl, rtracklayer::import)
# adding names from the file path
names(consensus_peaks) <- gsub("/scratch/Shares/rinnclass/CLASS_2022/JR/CLASS_2022/class_exeRcises/analysis/11_consensus_peaks/consensus_peaks/|_consensus_peaks.bed","", consensus_fl)
